# -*- coding: utf-8 -*-
# SADD RAILWAY.JOURNEY.SPOTS:SIDS 703 704 705 706 707 708 751 753 756 758 760 761 762 763 764 766 767 769 770 773 777 778 779 780 783 805 806 807 808 809 810 815 816 817 818 819 820 821 822 823
# SET RAILWAY.JOURNEY.SPOTS:SIDS:HEATS '[{"sid":"703","lng":116.024067,"lat":40.362639,"count":60},{"sid":"704","lng":116.190196,"lat":39.968527,"count":60},{"sid":"705","lng":116.195044,"lat":39.996194,"count":60},{"sid":"706","lng":116.278749,"lat":40.004869,"count":60},{"sid":"707","lng":116.403414,"lat":39.924091,"count":60},{"sid":"708","lng":116.293994,"lat":39.816772,"count":60},{"sid":"751","lng":116.417246,"lat":39.888243,"count":60},{"sid":"753","lng":116.634066,"lat":40.389444,"count":60},{"sid":"756","lng":116.00825,"lat":40.557933,"count":60},{"sid":"758","lng":116.343376,"lat":39.947735,"count":60},{"sid":"760","lng":116.402359,"lat":39.999763,"count":60},{"sid":"761","lng":116.215291,"lat":39.917734,"count":60},{"sid":"762","lng":116.571611,"lat":40.437442,"count":60},{"sid":"763","lng":116.402818,"lat":39.93227,"count":60},{"sid":"764","lng":116.400582,"lat":39.916702,"count":60},{"sid":"766","lng":116.396832,"lat":39.999271,"count":60},{"sid":"767","lng":116.347542,"lat":39.950277,"count":60},{"sid":"769","lng":116.326526,"lat":39.922467,"count":60},{"sid":"770","lng":116.388442,"lat":39.88066,"count":60},{"sid":"773","lng":116.32483,"lat":39.948437,"count":60},{"sid":"777","lng":116.39255,"lat":39.943627,"count":60},{"sid":"778","lng":116.501366,"lat":39.873848,"count":60},{"sid":"779","lng":116.231846,"lat":40.263544,"count":60},{"sid":"780","lng":116.12471,"lat":39.871839,"count":60},{"sid":"783","lng":116.39548,"lat":39.932909,"count":60},{"sid":"805","lng":116.091588,"lat":40.112884,"count":60},{"sid":"806","lng":116.489038,"lat":39.949955,"count":60},{"sid":"807","lng":116.444742,"lat":39.885848,"count":60},{"sid":"808","lng":116.309804,"lat":40.012658,"count":60},{"sid":"809","lng":116.362363,"lat":39.875778,"count":60},{"sid":"810","lng":116.421358,"lat":39.959903,"count":60},{"sid":"815","lng":116.393981,"lat":39.946208,"count":60},{"sid":"816","lng":116.423633,"lat":39.953628,"count":60},{"sid":"817","lng":115.781391,"lat":39.615208,"count":60},{"sid":"818","lng":116.03762,"lat":39.91122,"count":60},{"sid":"819","lng":116.043971,"lat":40.341849,"count":60},{"sid":"820","lng":116.079159,"lat":40.296972,"count":60},{"sid":"821","lng":116.359769,"lat":39.840957,"count":60},{"sid":"822","lng":116.673574,"lat":40.398683,"count":60},{"sid":"823","lng":116.396797,"lat":40.025231,"count":60}]'
# SET RAILWAY.JOURNEY.SPOTS:SIDS:HEATS:RELATION '{"1":100,"2":90,"3":80,"4":70,"5":60}'
# SET RAILWAY.JOURNEY.SPOTS:SIDS:REGION '[{"id":1,"name":"西城区","ifShow":true,"order":8001},{"id":2,"name":"东城区","ifShow":true,"order":8002},{"id":3,"name":"海淀区","ifShow":true,"order":8003},{"id":4,"name":"朝阳区","ifShow":true,"order":8004},{"id":5,"name":"丰台区","ifShow":true,"order":8005},{"id":6,"name":"石景山区","ifShow":true,"order":8006},{"id":7,"name":"顺义区","ifShow":false,"order":8007},{"id":8,"name":"昌平区","ifShow":true,"order":8008},{"id":9,"name":"通州区","ifShow":false,"order":8009},{"id":10,"name":"怀柔区","ifShow":false,"order":8010},{"id":11,"name":"密云区","ifShow":false,"order":8011},{"id":12,"name":"延庆区","ifShow":false,"order":8012},{"id":13,"name":"房山区","ifShow":true,"order":8013},{"id":14,"name":"大兴区","ifShow":false,"order":8014},{"id":15,"name":"门头沟区","ifShow":true,"order":8015},{"id":16,"name":"平谷区","ifShow":false,"order":8016},{"id":17,"name":"市郊铁路怀密线","ifShow":true,"order":7001},{"id":18,"name":"市郊铁路S2线","ifShow":true,"order":7002}]'
# SET RAILWAY.JOURNEY.SPOTS:SIDS:SUPPLEMENT '[{"sid":"703","rank":"5A级","open":"08:00-17:00","regionIds":[8,18]},{"sid":"704","rank":"4A级","open":"06:00-19:00","regionIds":[6]},{"sid":"705","rank":"4A级","open":"06:00-18:30","regionIds":[3]},{"sid":"706","rank":"5A级","open":"06:30-18:00","regionIds":[3]},{"sid":"707","rank":"5A级","open":"08:20-17:00","regionIds":[2]},{"sid":"708","rank":"5A级","open":"08:00-17:00","regionIds":[5]},{"sid":"751","rank":"5A级","open":"06:00-21:00","regionIds":[2]},{"sid":"753","rank":"4A级","open":"08:00-17:00","regionIds":[10,17]},{"sid":"756","rank":"4A级","open":"07:00-16:30","regionIds":[12,18]},{"sid":"758","rank":"","open":"07:30-18:00","regionIds":[1]},{"sid":"760","rank":"","open":"09:00-21:00","regionIds":[4]},{"sid":"761","rank":"4A级","open":"09:00-17:30","regionIds":[6]},{"sid":"762","rank":"5A级","open":"07:30-17:30","regionIds":[10,17]},{"sid":"763","rank":"4A级","open":"06:30-21:00","regionIds":[1]},{"sid":"764","rank":"4A级","open":"07:00-18:00","regionIds":[2]},{"sid":"766","rank":"4A级","open":"09:20-20:00","regionIds":[4]},{"sid":"767","rank":"4A级","open":"09:00-17:30","regionIds":[1]},{"sid":"769","rank":"4A级","open":"06:00-21:30","regionIds":[3]},{"sid":"770","rank":"4A级","open":"06:00-22:00","regionIds":[1]},{"sid":"773","rank":"4A级","open":"06:00-20:00","regionIds":[3]},{"sid":"777","rank":"5A级","open":"08:00-17:00","regionIds":[1]},{"sid":"778","rank":"4A级","open":"08:30-22:00","regionIds":[4]},{"sid":"779","rank":"5A级","open":"08:00-17:30","regionIds":[8,17]},{"sid":"780","rank":"5A级","open":"08:00-17:30","regionIds":[5]},{"sid":"783","rank":"4A级","open":"06:30-20:00","regionIds":[1]},{"sid":"805","rank":"4A级","open":"07:00-17:30","regionIds":[3]},{"sid":"806","rank":"4A级","open":"06:00-22:00","regionIds":[4]},{"sid":"807","rank":"","open":"06:00-22:00","regionIds":[2]},{"sid":"808","rank":"4A级","open":"07:00-21:00","regionIds":[3]},{"sid":"809","rank":"3A级","open":"07:30-17:00","regionIds":[1]},{"sid":"810","rank":"4A级","open":"06:00-21:30","regionIds":[2]},{"sid":"815","rank":"","open":"全天开放","regionIds":[1]},{"sid":"816","rank":"","open":"09:00-16:30","regionIds":[2]},{"sid":"817","rank":"4A级","open":"08:30-16:30","regionIds":[13]},{"sid":"818","rank":"","open":"08:30-16:30","regionIds":[15]},{"sid":"819","rank":"4A级","open":"07:00-17:00","regionIds":[8,18]},{"sid":"820","rank":"","open":"07:30-17:10","regionIds":[8,17]},{"sid":"821","rank":"4A级","open":"08:00-17:30","regionIds":[5]},{"sid":"822","rank":"4A级","open":"09:00-17:00","regionIds":[10,17]},{"sid":"823","rank":"","open":"06:00-20:00","regionIds":[4]}]'
import flask
import json
import redis
from flask import request
from flask import make_response

# SERVER CONFIG
host = '0.0.0.0'
port = 8803

# INTRANET REDIS
redisHost = '192.168.10.16'
redisPort = '6379'
redisPass = 'db490430abb8e9b38bf7dceff1de7e6950ba903f'
redisDb = '12'

# INTERNET REDIS
# redisHost='172.21.0.16'
# redisPort='6379'
# redisPass='112e670833c8736c'
# redisDb='2'

server = flask.Flask(__name__)
server.config['JSON_AS_ASCII'] = False


@server.route('/spots/heat/list', methods=['get'])
def get_heat_list():
    r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
    heat_result = r.get("RAILWAY.JOURNEY.SPOTS:SIDS:HEATS");
    heat_map = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:HEATS:RELATION')
    sid_infos = json.loads(heat_result)
    for sid_info in sid_infos:
        sid = sid_info["sid"]
        r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
        info_result = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:' + sid);
        level = json.loads(info_result)["ll"] if (info_result and info_result != '') else ''
        sid_info["count"] = json.loads(heat_map)[level] if (level != '') else 60

    response = make_response(json.dumps(sid_infos, ensure_ascii=False))
    response.headers['Access-Control-Allow-Origin'] = '*'
    return  response


@server.route('/spots/region/list', methods=['get'])
def get_region_list():
    r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
    result = r.get("RAILWAY.JOURNEY.SPOTS:SIDS:REGION");
    result_objs = json.loads(result)
    result_objs_new = []
    for obj in result_objs:
        if obj["ifShow"] == True:
            result_objs_new.append(obj)
            
    result_objs_new.sort(key=lambda x:x["order"])
    response = make_response(json.dumps(result_objs_new, ensure_ascii=False))
    response.headers['Access-Control-Allow-Origin'] = '*'
    return  response


@server.route('/spots/region/sights/list', methods=['get'])
def get_spots_list():
    r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
    region_id = request.values.get('regionId')
    result = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:SUPPLEMENT');
    result_objs = json.loads(result)
    spot_infos = []
    for suplplement_obj in result_objs:
        if int(region_id) in suplplement_obj["regionIds"]:
            spot_info = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:' + suplplement_obj["sid"]);
            spot_infos.append(json.loads(spot_info))
    
    response = make_response(json.dumps(spot_infos, ensure_ascii=False))
    response.headers['Access-Control-Allow-Origin'] = '*'
    return  response


@server.route('/spots/region/sights/info', methods=['get'])
def get_spots_info():
    r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
    result = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:' + request.values.get('sid'));
    result_obj = json.loads(result)
    if (result and result != ''):
        supplement = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:SUPPLEMENT');
        region = r.get('RAILWAY.JOURNEY.SPOTS:SIDS:REGION');
        suplplement_objs = json.loads(supplement)
        region_objs = json.loads(region)
        for suplplement_obj in suplplement_objs:
            if suplplement_obj["sid"] == request.values.get('sid'):
                result_obj["rank"] = suplplement_obj["rank"]
                result_obj["open"] = suplplement_obj["open"]
                temp_region = []
                for region_obj in region_objs:
                    if region_obj["id"] in suplplement_obj["regionIds"]:
                        temp_region.append(region_obj["name"])
                result_obj["region"] = temp_region
    else:
        result = "{}"
    response = make_response(json.dumps(result_obj, ensure_ascii=False))
    response.headers['Access-Control-Allow-Origin'] = '*'
    return  response


if __name__ == '__main__':
    server.run(host=host, port=port)
