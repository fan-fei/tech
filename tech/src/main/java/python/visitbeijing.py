# -*- coding: utf-8 -*-
# SADD SPOTS:FLOW:SIDS 703 704 705 706 707 708 751 753 756 758 760 761 762 763 764 766 767 769 770 773 777 778 779 780 783 805 806 807 808 809 810 815 816 817 818 819 820 821 822 823
# SET SPOTS:FLOW:SIDS:HEAT '[{"sid":"703","name":"八达岭","lng":116.024067,"lat":40.362639,"ll":5,"count":60,"rank":"5A级","region":"昌平区","open":"08:00-17:00","type":["s2","suburban"]},{"sid":"704","name":"八大处","lng":116.190196,"lat":39.968527,"ll":5,"count":60,"rank":"4A级","region":"石景山区","open":"06:00-19:00","type":["urban"]},{"sid":"705","name":"香山、植物园","lng":116.195044,"lat":39.996194,"ll":5,"count":60,"rank":"4A级","region":"海淀区","open":"06:00-18:30","type":["urban"]},{"sid":"706","name":"颐和园","lng":116.278749,"lat":40.004869,"ll":5,"count":60,"rank":"5A级","region":"海淀区","open":"06:30-18:00","type":["urban"]},{"sid":"707","name":"故宫","lng":116.403414,"lat":39.924091,"ll":5,"count":60,"rank":"5A级","region":"东城区","open":"08:20-17:00","type":["urban"]},{"sid":"708","name":"世界公园","lng":116.293994,"lat":39.816772,"ll":5,"count":60,"rank":"5A级","region":"丰台区","open":"08:00-17:00","type":["urban"]},{"sid":"751","name":"天坛公园","lng":116.417246,"lat":39.888243,"ll":5,"count":60,"rank":"5A级","region":"东城区","open":"06:00-21:00","type":["urban"]},{"sid":"753","name":"红螺寺","lng":116.634066,"lat":40.389444,"ll":5,"count":60,"rank":"4A级","region":"怀柔区","open":"08:00-17:00","type":["s5","suburban"]},{"sid":"756","name":"龙庆峡","lng":116.00825,"lat":40.557933,"ll":5,"count":60,"rank":"4A级","region":"延庆区","open":"07:00-16:30","type":["s2","urban"]},{"sid":"758","name":"动物园","lng":116.343376,"lat":39.947735,"ll":5,"count":60,"rank":"","region":"西城区","open":"07:30-18:00","type":["urban"]},{"sid":"760","name":"国家体育场","lng":116.402359,"lat":39.999763,"ll":5,"count":60,"rank":"","region":"朝阳区","open":"09:00-21:00","type":["urban"]},{"sid":"761","name":"石景山游乐园","lng":116.215291,"lat":39.917734,"ll":5,"count":60,"rank":"4A级","region":"石景山区","open":"09:00-17:30","type":["urban"]},{"sid":"762","name":"慕田峪长城","lng":116.571611,"lat":40.437442,"ll":5,"count":60,"rank":"5A级","region":"怀柔区","open":"07:30-17:30","type":["s5","suburban"]},{"sid":"763","name":"景山公园","lng":116.402818,"lat":39.93227,"ll":5,"count":60,"rank":"4A级","region":"西城区","open":"06:30-21:00","type":["urban"]},{"sid":"764","name":"中山公园","lng":116.400582,"lat":39.916702,"ll":5,"count":60,"rank":"4A级","region":"东城区","open":"07:00-18:00","type":["urban"]},{"sid":"766","name":"国家游泳中心","lng":116.396832,"lat":39.999271,"ll":5,"count":60,"rank":"4A级","region":"朝阳区","open":"09:20-20:00","type":["urban"]},{"sid":"767","name":"北京海洋馆","lng":116.347542,"lat":39.950277,"ll":5,"count":60,"rank":"4A级","region":"西城区","open":"09:00-17:30","type":["urban"]},{"sid":"769","name":"玉渊潭公园","lng":116.326526,"lat":39.922467,"ll":5,"count":60,"rank":"4A级","region":"海淀区","open":"06:00-21:30","type":["urban"]},{"sid":"770","name":"陶然亭景区","lng":116.388442,"lat":39.88066,"ll":5,"count":60,"rank":"4A级","region":"西城区","open":"06:00-22:00","type":["urban"]},{"sid":"773","name":"紫竹院公园","lng":116.32483,"lat":39.948437,"ll":5,"count":60,"rank":"4A级","region":"海淀区","open":"06:00-20:00","type":["urban"]},{"sid":"777","name":"恭王府","lng":116.39255,"lat":39.943627,"ll":5,"count":60,"rank":"5A级","region":"西城区","open":"08:00-17:00","type":["urban"]},{"sid":"778","name":"北京欢乐谷","lng":116.501366,"lat":39.873848,"ll":5,"count":60,"rank":"4A级","region":"朝阳区","open":"08:30-22:00","type":["urban"]},{"sid":"779","name":"十三陵","lng":116.231846,"lat":40.263544,"ll":5,"count":60,"rank":"5A级","region":"昌平区","open":"08:00-17:30","type":["s5","urban"]},{"sid":"780","name":"北宫森林公园","lng":116.12471,"lat":39.871839,"ll":5,"count":60,"rank":"5A级","region":"丰台区","open":"08:00-17:30","type":["urban"]},{"sid":"783","name":"北海公园","lng":116.39548,"lat":39.932909,"ll":5,"count":60,"rank":"4A级","region":"西城区","open":"06:30-20:00","type":["urban"]},{"sid":"805","name":"凤凰岭自然风景区","lng":116.091588,"lat":40.112884,"ll":5,"count":60,"rank":"4A级","region":"海淀区","open":"07:00-17:30","type":["urban"]},{"sid":"806","name":"朝阳公园","lng":116.489038,"lat":39.949955,"ll":5,"count":60,"rank":"4A级","region":"朝阳区","open":"06:00-22:00","type":["urban"]},{"sid":"807","name":"龙潭湖公园","lng":116.444742,"lat":39.885848,"ll":5,"count":60,"rank":"","region":"东城区","open":"06:00-22:00","type":["urban"]},{"sid":"808","name":"圆明园遗址公园","lng":116.309804,"lat":40.012658,"ll":5,"count":60,"rank":"4A级","region":"海淀区","open":"07:00-21:00","type":["urban"]},{"sid":"809","name":"大观园公园","lng":116.362363,"lat":39.875778,"ll":5,"count":60,"rank":"3A级","region":"西城区","open":"07:30-17:00","type":["urban"]},{"sid":"810","name":"地坛公园","lng":116.421358,"lat":39.959903,"ll":5,"count":60,"rank":"4A级","region":"东城区","open":"06:00-21:30","type":["urban"]},{"sid":"815","name":"什刹海","lng":116.393981,"lat":39.946208,"ll":5,"count":60,"rank":"","region":"西城区","open":"全天开放","type":["urban"]},{"sid":"816","name":"雍和宫","lng":116.423633,"lat":39.953628,"ll":5,"count":60,"rank":"","region":"东城区","open":"09:00-16:30","type":["urban"]},{"sid":"817","name":"云居寺","lng":115.781391,"lat":39.615208,"ll":5,"count":60,"rank":"4A级","region":"房山区","open":"08:30-16:30","type":["suburban"]},{"sid":"818","name":"潭柘寺","lng":116.03762,"lat":39.91122,"ll":5,"count":60,"rank":"","region":"门头沟区","open":"08:30-16:30","type":["suburban"]},{"sid":"819","name":"水关长城","lng":116.043971,"lat":40.341849,"ll":5,"count":60,"rank":"4A级","region":"昌平区","open":"07:00-17:00","type":["suburban"]},{"sid":"820","name":"居庸关","lng":116.079159,"lat":40.296972,"ll":5,"count":60,"rank":"","region":"昌平区","open":"07:30-17:10","type":["s5","suburban"]},{"sid":"821","name":"世界花卉大观园","lng":116.359769,"lat":39.840957,"ll":5,"count":60,"rank":"4A级","region":"丰台区","open":"08:00-17:30","type":["urban"]},{"sid":"822","name":"雁栖湖","lng":116.673574,"lat":40.398683,"ll":5,"count":60,"rank":"4A级","region":"怀柔区","open":"09:00-17:00","type":["s5","suburban"]},{"sid":"823","name":"奥林匹克森林公园","lng":116.396797,"lat":40.025231,"ll":5,"count":60,"rank":"","region":"朝阳区","open":"06:00-20:00","type":["urban"]}]'
# SET SPOTS:FLOW:SIDS:HEAT:MAP '{"1":100,"2":90,"3":80,"4":70,"5":60}'
import flask
import json
import redis
from flask import request
from flask import make_response

# SERVER CONFIG
host = '0.0.0.0'
port = 8803

# INTRANET REDIS
redisHost = '192.168.10.16'
redisPort = '6379'
redisPass = 'db490430abb8e9b38bf7dceff1de7e6950ba903f'
redisDb = '12'

# INTERNET REDIS
# redisHost='172.21.0.16'
# redisPort='6379'
# redisPass='112e670833c8736c'
# redisDb='2'

server = flask.Flask(__name__)
server.config['JSON_AS_ASCII'] = False


@server.route('/spots/info', methods=['get'])
def get_spots_info():
    r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
    result = r.get('SPOTS:FLOW:SIDS:INFO:' + request.values.get('sid'));
    result = result if (result and result != '') else '{}'
    response = make_response(result)
    response.headers['Access-Control-Allow-Origin'] = '*'
    return  response

    
@server.route('/spots/list', methods=['get'])
def get_spots_level():
    r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
    heat_result = r.get("SPOTS:FLOW:SIDS:HEAT");
    heat_map = r.get('SPOTS:FLOW:SIDS:HEAT:MAP')
    sid_infos = json.loads(heat_result)
    for sid_info in sid_infos:
        sid = sid_info["sid"]
        r = redis.Redis(host=redisHost, port=redisPort, db=redisDb, password=redisPass)
        info_result = r.get('SPOTS:FLOW:SIDS:INFO:' + sid);
        level = json.loads(info_result)["ll"] if (info_result and info_result != '') else ''
        sid_info["ll"] = int(level) if (level != '') else -1
        sid_info["count"] = json.loads(heat_map)[level] if (level != '') else 60
    
    sid_infos_new = {"heatInfo":[], "spotInfo":{"s5":[], "s2":[], "urban":[], "suburban":[]}}
    for i in range(len(sid_infos)):
        if sid_infos[i]["ll"] != -1:
            obj={}
            obj["sid"]=(sid_infos[i]["sid"])
            obj["lng"]=(sid_infos[i]["lng"])
            obj["lat"]=(sid_infos[i]["lat"])
            obj["count"]=(sid_infos[i]["count"])
            sid_infos_new["heatInfo"].append(obj)
            
    for i in range(len(sid_infos)):
        if sid_infos[i]["ll"] != -1 and "s5" in sid_infos[i]["type"]:
            sid_infos_new["spotInfo"]["s5"].append(sid_infos[i])
        if sid_infos[i]["ll"] != -1 and "s2" in sid_infos[i]["type"]:
            sid_infos_new["spotInfo"]["s2"].append(sid_infos[i])
        if sid_infos[i]["ll"] != -1 and "urban" in sid_infos[i]["type"] :
            sid_infos_new["spotInfo"]["urban"].append(sid_infos[i])
        if sid_infos[i]["ll"] != -1 and "suburban" in sid_infos[i]["type"] :
            sid_infos_new["spotInfo"]["suburban"].append(sid_infos[i])

    response = make_response(json.dumps(sid_infos_new, sort_keys=True, ensure_ascii=False))
    response.headers['Access-Control-Allow-Origin'] = '*'
    return  response


if __name__ == '__main__':
    server.run(host=host, port=port)
